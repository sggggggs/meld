<html>
    <head>
        <template id="template-row">
            <tr class="piece-row">
            </tr>
        </template>
        <template id="template-row-cell">
            <td class="piece-row-cell %stat%">
                <span class="piece-entry-container">
                    <span class="piece-entry"><span class="piece-stat"></span><span class="piece-add-div">+</span><span class="piece-add"></span></span>
                    <span class="piece-entry"><span class="piece-total"></span><span class="piece-cap-div">/</span><span class="piece-cap"></span></span>
                </span>
            </td>
        </template>
        <template id="template-row-header">
            <td class="piece-row-cell piece-row-header">
                %value%
            </td>
        </template>
        <template id="template-row-cell-materia">
            <td class="piece-row-cell-materia"></td>
        </template>
        <template id="template-table">
            <table class="slot-table">
                <tr class="slot-header">
                </tr>
            </table>
        </template>
        <template id="template-header-cell">
            <th class="slot-header-cell">%value%</th>
        </template>
        <template id="template-materia-slot">
            <div class="materia-slot">
                    &nbsp;
            </div>
        </template>
        <template id="template-materia-modal">
            <div class="materia-modal">
                <div id="materia-modal-header"></div>
                <select id="materia-modal-dropdown">
                </select>
            </div>
        </template>
        <link rel="stylesheet" type="text/css" href="index.css">
    </head>
    <body>
        <header>
            <label for="job-picker">Job</label>
            <select id="job-picker"></select>
            <button id="generate-save">Generate</button><input id="generate-output" type="text">
            <button id="load-save">Load</button><input id="load-input" type="text">
        </header>
        <div id="container"></div>
    </body>
</html>
<script type="module">
    import Job from "./js/job.js";
    import MateriaModal from "./js/materiamodal.js";
    import Data from "./js/data.js";
    import Saver from "./js/saver.js";
    
    const jobPicker = document.getElementById("job-picker");
    const container = document.getElementById("container");
    const generateSaveButton = document.getElementById("generate-save");
    const loadSaveButton = document.getElementById("load-save");
    const generateOutputField = document.getElementById("generate-output");
    const loadInputField = document.getElementById("load-input");

    let currentJob = null;

    const setJob = (job) => {
        currentJob = job;
        jobPicker.value = job.job;
        while (container.firstChild) {
            container.removeChild(container.firstChild);
        }
        container.appendChild(currentJob.node());
    }

    const onload = () => {
        document.body.appendChild(MateriaModal.Instance.node());
        jobPicker.append(
            document.createElement("option"),
            ...Data.Jobs.map(job => {
                const option = document.createElement("option");
                option.textContent = job;
                option.value = job;
                return option;
            })
        );
        jobPicker.addEventListener("change", event => {
            const job = event.target.value;
            if (job) {
                currentJob = new Job(job);
                setJob(currentJob);
            }
        });
        generateSaveButton.addEventListener("click", () => {
            if (currentJob) {
                console.log(Saver.Generate(currentJob));
                generateOutputField.value = Saver.Encode(Saver.Generate(currentJob));
            }
        });
        loadSaveButton.addEventListener("click", () => {
            try {
                setJob(Saver.Load(Saver.Decode(loadInputField.value)));
            } catch(err) {
                console.error(err);
            }
        });
    };

    window.onload = onload;
</script>